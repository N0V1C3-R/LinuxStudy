# Linux日志
---
## 1. 基本介绍
1. 日志文件是重要的系统信息文件，其中记录了许多重要的系统时间，包括用户的登陆信息、系统的启动信息、系统的安全信息、邮件相关信息、各种服务相关信息等  
2. 日志对于安全来说也很重要，它记录了系统每天发生的各种事，通过日志来检查错误发生的原因，或者受到攻击时攻击者留下的痕迹  
3. 可以将日志理解成记录重大事件的工具，绝大部分的日志存放在 */var/log* 目录下
---
## 2. 系统常用日志
| 日志文件              | 说明                                                                                                                                                              |
| --------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **/var/log/boot.log** | 系统启动日志                                                                                                                                                      |
| **/var/log/cron**     | 记录与系统定时任务有关的日志                                                                                                                                      |
| /var/log/cups         | 记录打印信息的日志                                                                                                                                                |
| /var/log/dmesg        | 记录了系统在开机时内核自检的信息，也可以使用`dmesg`命令直接查看内核自检信息                                                                                       |
| /var/log/btmp         | 记录错误登录的日志。这个文件是二进制文件，不能直接用`vi`查看，而要使用`astb`命令查看                                                                              |
| **/var/log/lasllog**  | 记录系统中所有用户最后一次的登录时间的日志，这个文件也是二进制文件，需要使用`lastlog`命令查看                                                                     |
| **/var/log/mailog**   | 记录邮件信息的日志                                                                                                                                                |
| **/var/log/message**  | 记录系统重要消息的日志，这个日志文件中会记录Linux系统的绝大多数重要信息，如果系统出现问题，首先要检查的就是这个日志文件                                           |
| **/var/log/secure**   | 记录验证和授权方面的信息，只要涉及账户和密码的程序都会记录，比如系统的登录、ssh的登录、su切换用户、sudo授权等，甚至添加用户和修改用户密码都会记录在这个文件日志中 |
| /var/log/wtmp         | 永久记录所有用户的登录、注销信息，同时记录系统的启动、重启、关机时间，是二进制文件，需要使用`ast`命令查看                                                         |
| **/var/tun/ulmp**     | 记录当前已经登录的用户信息，这个文件会随着用户的登录和注销而不断变化，只记录当前登录用户的信息。这个文件不能用`vi`查看，而要使用`w`、`who`、`users`等命令查看     |
---
## 3. 日志管理服务
+ 基本介绍
  CentOS7.6日志服务是 *rsyslogd* ，CentOS6.x日志服务是 *syslogd* 。rsyslogd功能更加强大，rsysload的使用、日志文件的格式和syslogd服务是兼容的  
+ 查询Linux中的 *rsyslogd* 服务是否启动
  `ps -aux | grep "rsyslogd" | grep -v "grep"`
+ 查询 *rsyslogd* 服务的自启动状态
  `systemctl list-unit-files | grep rsyslogd`
+ 配置文件： */etc/rsyslogd.conf*
  编辑文件时的格式： *\*.\* 存放日志文件*   
  其中第一个\*代表日志类型，第二个\*代表日志级别  
  + 日志类型说明
    | 日志类型               | 说明                                |
    | ---------------------- | ----------------------------------- |
    | *auth*                 | pam产生的日志                       |
    | *authpriv*             | ssh、ftp等登录信息的验证信息        |
    | *corn*                 | 时间任务相关                        |
    | *kern*                 | 内核                                |
    | *lpr*                  | 打印                                |
    | *mail*                 | 邮件                                |
    | *mark(syslog)-rsyslog* | 服务内部的信息，时间标识            |
    | *news*                 | 新闻组                              |
    | *user*                 | 用户程序产生的相关信息              |
    | *uucp*                 | unix to unix copy主机之间相关的通道 |
    | *local 1-7*            | 自定义的日志设备                    |
  + 日志级别说明
    | 日志级别  | 说明                                                 |
    | --------- | ---------------------------------------------------- |
    | *debug*   | 有调试信息的，日志通信最多                           |
    | *info*    | 一般信息日志，最常用                                 |
    | *notice*  | 最具有重要新的普通条件的信息                         |
    | *warning* | 警告级别                                             |
    | *err*     | 错误级别，阻止某个功能或者模块不能正常工作的信息     |
    | *crit*    | 严重级别，阻止整个系统或者整个软件不能正常工作的信息 |
    | *alert*   | 需要立刻修改的信息                                   |
    | *emerg*   | 内核崩溃等重要信息                                   |
    | *none*    | 什么都不记录                                         |
    注意：从上到下，级别从低到高，记录信息越来越少
+ 日志的信息
   由日志服务rsyslogd记录的日志文件，日志文件的格式包含以下4列：
   1. 事件产生的时间  
   2. 产生事件的服务器主机名  
   3. 产生事件的服务名或程序名  
   4. 事务的具体信息
---
## 4. 日志轮替
+ 基本介绍
  日志轮替就是把旧的日志文件移动并改名，同时建立新的空日志文件，当旧日志文件超出保存的范围之后，就会进行删除，
+ 日志轮替文件命名
  1. CentOS7使用 *logrotate* 进行日志轮替管理，想要改变日志轮替文件名字，通过 */etc/logrotate.conf* 配置文件中 **dateext** 参数设置。 */etc/logrotate.conf* 是全局的日志轮替策略/规则，也可以给某个单独的日志文件指定策略（可以把某个单独日志文件的论题规则写到 */etc/logrotate.d/* 目录下）
  2. 如果配置文件中有 **dateext** 参数，那么日志会用日期来作为日志文件的后缀，例如 *secure-20200418* 。这样日志文件名不会重叠，也就不需要日志文件的改名，只需要指定保存日志个数，删除多余的日志文件即可  
  3. 如果配置文件中没有 **dateext** 参数，日志文件就需要进行改名。当第一次进行日志轮替是，当前 *secure* 日志会自动改名为 *secure.1* ，然后新建 *secure* 日志，用来保存新的日志。当第二次进行日志论题是， *secure.1* 会自动改名为 *secure.2* ，当前的 *secure* 日志会自动改名为 *secure.1* ，然后也会新建 *secure* 日志，用来保存新的日志，依次类推
+ *logrotate* 配置文件
  + */etc/logrotate.conf* 为 **logrotate** 的全局配置文件
    ```
    # see "man logrotate" for details
    # rotate log files weekly 每周对日志文件进行一次轮替
    weekly
    # keep 4 weeks worth of backlogs 共保存4份日志文件，当建立新的日志文件时，旧的将会被删除
    rotate 4
    # create new (empty) log files after rotating old ones 创建新的空文件日志，在日志轮替后
    create
    # use date as a suffix of the rotated file 使用日期作为日志轮替文件的后缀
    dateext
    # uncomment this if you want your log files compressed 日志文件是否压缩，如果取消注释，择日只会在转储的同时进行压缩
    #compress
    # RPM packages drop log rotation information into this directory
    include /etc/logrotate.d
    #包含/etc/logrotate.d/目录中所有的子配置文件，也就是说会把这个目录中所有子配置文件读取进来
    # system-specific logs may be also be configured here.
    ```
+ 日志轮替的参数说明
  | 参数                      | 参数说明                                                                               |
  | :------------------------ | :------------------------------------------------------------------------------------- |
  | *daily*                   | 日志的轮替周期时每天                                                                   |
  | *weekly*                  | 日志的轮替周期是每月                                                                   |
  | *monthly*                 | 日志的轮替周期是每月                                                                   |
  | *rotate 数字*             | 保留的日志文件个数，0指没有备份                                                        |
  | *compress*                | 日志轮替时，旧的日志进行压缩                                                           |
  | *create mode owner group* | 建立新日志，同时指定新日志的权限与所有者和所属组                                       |
  | *mail address*            | 当日志轮替时，输出内容通过邮件发送到指定的邮件地址                                     |
  | *missingok*               | 当日志不存在时，则忽略改日值得警告信息                                                 |
  | *notifempty*              | 当日志为空文件时，不进行日志轮替                                                       |
  | *minsize 大小*            | 日志轮替的最小值，也就是日志一定要达到这个最小值才会轮替，否则就算事件达到也不进行轮替 |
  | *size 大小*               | 日志之有大于指定大小才进行日志轮替，而不是按照时间轮替                                 |
  | *dateext*                 | 使用日期作为日志轮替文件的后缀                                                         |
  | *sharedscripts*           | 再次关键字之后的脚本只执行一次                                                         |
  | *preotate/endscript*      | 在日志轮替之前执行脚本命令                                                             |
  | *postrotate/endscript*    | 在日志轮替之后执行脚本命令                                                             |
+ 日志轮替机制的原理
  日志轮替之所以可以在指定的时间备份日志，是依赖系统定时任务，在 */etc/cron,daily/* 目录，就会发现这个目录中有 *logrotate* 文件（可执行），这个文件依赖定时任务执行
---
## 5. 内存日志
+ 基本介绍
  在Linux里面，有一部分日志是先写入内存中而不是文件中，它是实时变化的，当重启时内存日志将会清空
+ 基本语法
  `journalctl`&emsp;查看全部内存日志  
  `journalctl -n 3`&emsp;查看3条内存日志  
  `journalctl --since 19:00 --unit 19:10:10`&emsp;查看起始时间到结束时间的日志（可追加日期）  
  `journalctl -p -err`&emsp;报错日志  
  `journalctl -o verbose`&emsp;日志详细内容  
  `journalctl_PID=进程号 _COMM=进程名`&emsp;查看包含这些参数的日志（在详细日志查看或者使用`journalctl | grep xxx`）  